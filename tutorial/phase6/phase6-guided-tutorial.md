# é˜¶æ®µå…­:é…ç½®ç®¡ç†ä¸ç”Ÿäº§éƒ¨ç½²(å¯å‘å¼æ•™ç¨‹)

> ğŸ¯ **å­¦ä¹ ç›®æ ‡**:ä»å¼€å‘ç¯å¢ƒèµ°å‘ç”Ÿäº§ç¯å¢ƒ,æŒæ¡ç°ä»£åŒ–è½¯ä»¶éƒ¨ç½²çš„æ ¸å¿ƒæŠ€èƒ½
>
> ğŸ“š **æ•™å­¦ç†å¿µ**:é€šè¿‡æ€è€ƒ"ä¸ºä»€ä¹ˆéœ€è¦è¿™æ ·éƒ¨ç½²"è€Œä¸ä»…ä»…æ˜¯"å¦‚ä½•éƒ¨ç½²",åŸ¹å…»å·¥ç¨‹å¸ˆçš„ç³»ç»Ÿæ€ç»´
>
> ğŸ§  **èƒ½åŠ›åŸ¹å…»**:ä»"èƒ½è·‘èµ·æ¥"åˆ°"ç¨³å®šè¿è¡Œ",ä»"æœ¬åœ°å¼€å‘"åˆ°"ç”Ÿäº§éƒ¨ç½²"çš„è´¨çš„é£è·ƒ

---

## ğŸŒŸ æ ¸å¿ƒæ€è€ƒ:å¼€å‘ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒçš„é¸¿æ²Ÿ

åœ¨å¼€å§‹éƒ¨ç½²å·¥ä½œä¹‹å‰,è®©æˆ‘ä»¬å…ˆæ€è€ƒä¸€ä¸ªæ ¹æœ¬æ€§é—®é¢˜:

### é—®é¢˜1:ä¸ºä»€ä¹ˆ"åœ¨æˆ‘çš„æœºå™¨ä¸Šèƒ½è·‘"è¿˜ä¸å¤Ÿ?

**æ€è€ƒåœºæ™¯**:ä½ åˆšåˆšåœ¨æœ¬åœ°å¼€å‘ç¯å¢ƒå®Œæˆäº†æ•´ä¸ªèŠå¤©æœåŠ¡å™¨,æ‰€æœ‰åŠŸèƒ½éƒ½æµ‹è¯•é€šè¿‡,ä»£ç æäº¤åˆ°äº†ä»£ç ä»“åº“ã€‚ç°åœ¨éœ€è¦éƒ¨ç½²åˆ°äº‘æœåŠ¡å™¨ä¸Šä¾›ç”¨æˆ·ä½¿ç”¨ã€‚

è®©æˆ‘ä»¬æ·±å…¥æ€è€ƒå¼€å‘ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒçš„å·®å¼‚:

1. **ç¯å¢ƒä¸€è‡´æ€§é—®é¢˜**:
   - ä½ çš„å¼€å‘æœºå™¨æ˜¯ macOS,ä½†æœåŠ¡å™¨æ˜¯ Ubuntu 22.04
   - æœ¬åœ° MySQL ç‰ˆæœ¬æ˜¯ 8.0,æœåŠ¡å™¨ä¸Šæ˜¯ 5.7
   - æœ¬åœ°æœ‰å®Œæ•´çš„å¼€å‘å·¥å…·é“¾,æœåŠ¡å™¨åº”è¯¥åªä¿ç•™è¿è¡Œæ—¶ä¾èµ–

2. **é…ç½®ç®¡ç†é—®é¢˜**:
   - å¼€å‘æ—¶æ•°æ®åº“å¯†ç æ˜¯ "test123",ç”Ÿäº§ç¯å¢ƒåº”è¯¥ç”¨å¼ºå¯†ç 
   - å¼€å‘æ—¶ AI API å¯†é’¥å¯èƒ½æ˜¯æµ‹è¯•è´¦å·,ç”Ÿäº§ç¯å¢ƒè¦ç”¨ä»˜è´¹è´¦å·
   - å¼€å‘æ—¶ç«¯å£æ˜¯ 8080,ç”Ÿäº§ç¯å¢ƒè¦ç”¨ 80 (HTTP) å’Œ 443 (HTTPS)

3. **ç¨³å®šæ€§è¦æ±‚é—®é¢˜**:
   - å¼€å‘æ—¶ç¨‹åºå´©æºƒå¯ä»¥æ‰‹åŠ¨é‡å¯,ç”Ÿäº§ç¯å¢ƒéœ€è¦è‡ªåŠ¨æ¢å¤
   - å¼€å‘æ—¶åªæœ‰ä½ ä¸€ä¸ªç”¨æˆ·,ç”Ÿäº§ç¯å¢ƒè¦æ”¯æŒæˆç™¾ä¸Šåƒå¹¶å‘ç”¨æˆ·
   - å¼€å‘æ—¶æ—¥å¿—å¯ä»¥è¾“å‡ºåˆ°æ§åˆ¶å°,ç”Ÿäº§ç¯å¢ƒéœ€è¦æŒä¹…åŒ–æ—¥å¿—å¹¶å®šæœŸæ¸…ç†

**æ ¸å¿ƒæ´å¯Ÿ**:**éƒ¨ç½²ä¸æ˜¯ç®€å•çš„"æŠŠä»£ç æ‹·è´åˆ°æœåŠ¡å™¨",è€Œæ˜¯æ„å»ºä¸€ä¸ªå¯é ã€å®‰å…¨ã€å¯ç»´æŠ¤çš„ç”Ÿäº§ç³»ç»Ÿ**

---

## ğŸ—‚ï¸ é…ç½®ç®¡ç†çš„å“²å­¦

### é—®é¢˜2:ç¡¬ç¼–ç é…ç½®æœ‰ä»€ä¹ˆé—®é¢˜?

**åé¢ç¤ºä¾‹ - ç¡¬ç¼–ç é…ç½®**:
```cpp
// main.cpp (ç³Ÿç³•çš„åšæ³•)
int main() {
    auto& dbPool = http::db::DbConnectionPool::getInstance();
    dbPool.init("localhost", "chatserver", "password123",
                "chatserver_db", 10);  // å¯†ç ç¡¬ç¼–ç !

    http::HttpServer server(80, "ChatServer");
    // ...
}
```

**æ€è€ƒè¿™ä¸ªè®¾è®¡çš„é—®é¢˜**:

1. **å®‰å…¨é£é™©**:
   - æ•°æ®åº“å¯†ç æ˜æ–‡å­˜åœ¨ä»£ç ä¸­
   - ä¸€æ—¦ä»£ç æ³„éœ²(å¦‚æäº¤åˆ°å…¬å¼€ GitHub ä»“åº“),å¯†ç éšä¹‹æ³„éœ²
   - ä¿®æ”¹å¯†ç éœ€è¦é‡æ–°ç¼–è¯‘æ•´ä¸ªé¡¹ç›®

2. **ç¯å¢ƒåˆ‡æ¢å›°éš¾**:
   - å¼€å‘ç¯å¢ƒã€æµ‹è¯•ç¯å¢ƒã€ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ä¸åŒé…ç½®
   - æ¯æ¬¡åˆ‡æ¢ç¯å¢ƒéƒ½è¦ä¿®æ”¹ä»£ç ã€é‡æ–°ç¼–è¯‘
   - å®¹æ˜“è¯¯å°†æµ‹è¯•é…ç½®éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ

3. **å›¢é˜Ÿåä½œå†²çª**:
   - ä¸åŒå¼€å‘è€…çš„æœ¬åœ°æ•°æ®åº“é…ç½®ä¸åŒ
   - æ¯ä¸ªäººéƒ½è¦ä¿®æ”¹ä»£ç æ‰èƒ½åœ¨æœ¬åœ°è¿è¡Œ
   - Git åˆå¹¶æ—¶ä¼šäº§ç”Ÿå¤§é‡é…ç½®å†²çª

### æ­£ç¡®çš„é…ç½®ç®¡ç†ç­–ç•¥

**è®¾è®¡æ€è€ƒ**:é…ç½®åº”è¯¥å¦‚ä½•ç®¡ç†?

1. **é…ç½®å¤–éƒ¨åŒ–**:
   - é…ç½®å­˜å‚¨åœ¨ç‹¬ç«‹çš„é…ç½®æ–‡ä»¶ä¸­(å¦‚ `config.json`)
   - ç¨‹åºå¯åŠ¨æ—¶è¯»å–é…ç½®æ–‡ä»¶
   - ä¸åŒç¯å¢ƒä½¿ç”¨ä¸åŒçš„é…ç½®æ–‡ä»¶

2. **æ•æ„Ÿä¿¡æ¯ä¿æŠ¤**:
   - å¯†ç ã€API å¯†é’¥ç­‰æ•æ„Ÿä¿¡æ¯ä½¿ç”¨ç¯å¢ƒå˜é‡æ³¨å…¥
   - é…ç½®æ–‡ä»¶æ¨¡æ¿(`.example`)æäº¤åˆ° Git
   - çœŸå®é…ç½®æ–‡ä»¶(`.json`)æ·»åŠ åˆ° `.gitignore`

3. **é…ç½®åˆ†å±‚**:
   - **åŸºç¡€é…ç½®**:æœåŠ¡å™¨ç«¯å£ã€çº¿ç¨‹æ•°ç­‰å…¬å…±é…ç½®
   - **æ•°æ®åº“é…ç½®**:è¿æ¥ä¿¡æ¯ã€è¿æ¥æ± å¤§å°
   - **AI æœåŠ¡é…ç½®**:API å¯†é’¥ã€æ¨¡å‹å‚æ•°
   - **ä¸šåŠ¡é…ç½®**:ä¼šè¯è¶…æ—¶ã€ä¸Šä¼ å¤§å°é™åˆ¶ç­‰

**å®è·µç»ƒä¹  - è®¾è®¡é…ç½®ç»“æ„**:

åŸºäº TODO.md ç¬¬ 6.1 èŠ‚çš„é…ç½®ç¤ºä¾‹,æ€è€ƒ:

```json
{
  "server": {
    "port": 80,
    "threads": 4,
    "ssl_enabled": false,
    "ssl_cert": "/path/to/cert.pem",
    "ssl_key": "/path/to/key.pem"
  },
  "database": {
    "host": "localhost",
    "port": 3306,
    "user": "chatserver",
    "password": "your_password",    // é—®é¢˜:å¯†ç æ˜æ–‡å­˜å‚¨?
    "database": "chatserver_db",
    "pool_size": 10
  },
  "ai": {
    "default_model": "qwen",
    "qwen": {
      "api_key": "your_api_key",    // é—®é¢˜:API å¯†é’¥ç›´æ¥å†™åœ¨é…ç½®é‡Œ?
      "endpoint": "https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation"
    }
  }
}
```

**æ”¹è¿›æ€è€ƒ**:

1. **å¦‚ä½•é¿å…æ•æ„Ÿä¿¡æ¯æ³„éœ²?**
   - é…ç½®æ–‡ä»¶ä¸­ä½¿ç”¨å ä½ç¬¦:`"password": "${DB_PASSWORD}"`
   - ç¨‹åºå¯åŠ¨æ—¶ä»ç¯å¢ƒå˜é‡è¯»å–:`std::getenv("DB_PASSWORD")`
   - æˆ–ä½¿ç”¨ä¸“é—¨çš„å¯†é’¥ç®¡ç†æœåŠ¡(å¦‚ HashiCorp Vault)

2. **å¦‚ä½•æ”¯æŒå¤šç¯å¢ƒ?**
   ```bash
   config/
   â”œâ”€â”€ config.json.example      # é…ç½®æ¨¡æ¿,æäº¤åˆ° Git
   â”œâ”€â”€ config.dev.json          # å¼€å‘ç¯å¢ƒ(æœ¬åœ°,ä¸æäº¤)
   â”œâ”€â”€ config.test.json         # æµ‹è¯•ç¯å¢ƒ(ä¸æäº¤)
   â””â”€â”€ config.prod.json         # ç”Ÿäº§ç¯å¢ƒ(ä¸æäº¤)
   ```

   å¯åŠ¨æ—¶æŒ‡å®šé…ç½®æ–‡ä»¶:
   ```bash
   ./http_server --config config/config.prod.json
   ```

3. **å¦‚ä½•éªŒè¯é…ç½®çš„æ­£ç¡®æ€§?**
   - ç¨‹åºå¯åŠ¨æ—¶éªŒè¯å¿…å¡«é¡¹æ˜¯å¦å­˜åœ¨
   - éªŒè¯æ•°å€¼èŒƒå›´(å¦‚ç«¯å£ 1-65535ã€çº¿ç¨‹æ•° > 0)
   - éªŒè¯æ–‡ä»¶è·¯å¾„æ˜¯å¦å­˜åœ¨(è¯ä¹¦æ–‡ä»¶ã€æ¨¡å‹æ–‡ä»¶)

---

## ğŸ—ï¸ éƒ¨ç½²æ¶æ„è®¾è®¡æ€è€ƒ

### é—®é¢˜3:åº”è¯¥å¦‚ä½•éƒ¨ç½²æˆ‘ä»¬çš„åº”ç”¨?

**ä¸‰ç§å¸¸è§éƒ¨ç½²æ–¹å¼å¯¹æ¯”**:

| éƒ¨ç½²æ–¹å¼ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|---------|------|------|---------|
| **ç›´æ¥éƒ¨ç½²** | ç®€å•ç›´æ¥,æ§åˆ¶åŠ›å¼º | ç¯å¢ƒä¾èµ–å¤æ‚,éš¾ä»¥è¿ç§» | å­¦ä¹ é˜¶æ®µã€å°å‹é¡¹ç›® |
| **Systemd æœåŠ¡** | è‡ªåŠ¨å¯åŠ¨ã€æ—¥å¿—ç®¡ç† | ä»éœ€æ‰‹åŠ¨ç®¡ç†ä¾èµ– | ä¼ ç»ŸæœåŠ¡å™¨éƒ¨ç½² |
| **Docker å®¹å™¨** | ç¯å¢ƒä¸€è‡´ã€æ˜“äºæ‰©å±• | å­¦ä¹ æˆæœ¬ã€èµ„æºå¼€é”€ | ç°ä»£åŒ–ç”Ÿäº§ç¯å¢ƒ |

### æ–¹å¼ä¸€:ç›´æ¥éƒ¨ç½²(å¿«é€Ÿä½†ä¸ç¨³å®š)

**æ“ä½œæµç¨‹**:
```bash
# 1. ä¸Šä¼ ä»£ç åˆ°æœåŠ¡å™¨
scp -r SiriusX-HttpServer/ user@server:/opt/

# 2. ç¼–è¯‘
cd /opt/SiriusX-HttpServer/build
cmake .. && make

# 3. è¿è¡Œ
sudo ./http_server
```

**æ€è€ƒé—®é¢˜**:

1. **è¿›ç¨‹ç®¡ç†**:
   - å…³é—­ SSH è¿æ¥åç¨‹åºä¼šç»ˆæ­¢å—? (ç­”æ¡ˆ:ä¼š,é™¤éä½¿ç”¨ `nohup` æˆ– `screen`)
   - ç¨‹åºå´©æºƒåå¦‚ä½•è‡ªåŠ¨é‡å¯?
   - å¦‚ä½•ä¼˜é›…åœ°åœæ­¢ç¨‹åº?

2. **æ—¥å¿—ç®¡ç†**:
   - æ—¥å¿—è¾“å‡ºåˆ°å“ªé‡Œ? (æ ‡å‡†è¾“å‡º?æ–‡ä»¶?)
   - æ—¥å¿—æ–‡ä»¶ä¼šæ— é™å¢é•¿å—?
   - å¦‚ä½•æŸ¥çœ‹å†å²æ—¥å¿—?

3. **å¼€æœºå¯åŠ¨**:
   - æœåŠ¡å™¨é‡å¯åç¨‹åºä¼šè‡ªåŠ¨å¯åŠ¨å—?
   - å¯åŠ¨é¡ºåºå¦‚ä½•ä¿è¯? (MySQL â†’ RabbitMQ â†’ åº”ç”¨)

**æ”¹è¿›æ–¹æ¡ˆ**:åå°è¿è¡Œå¹¶è®°å½•æ—¥å¿—
```bash
nohup sudo ./http_server > /var/log/chatserver.log 2>&1 &

# æŸ¥çœ‹æ—¥å¿—
tail -f /var/log/chatserver.log

# åœæ­¢ç¨‹åº
ps aux | grep http_server
sudo kill <PID>
```

### æ–¹å¼äºŒ:Systemd æœåŠ¡åŒ–(æ¨èçš„ç”Ÿäº§æ–¹å¼)

**ä¸ºä»€ä¹ˆéœ€è¦ Systemd?**

Systemd æ˜¯ Linux ç³»ç»Ÿçš„æœåŠ¡ç®¡ç†å™¨,æä¾›:
- **è‡ªåŠ¨å¯åŠ¨**:ç³»ç»Ÿå¯åŠ¨æ—¶è‡ªåŠ¨è¿è¡Œ
- **å´©æºƒæ¢å¤**:ç¨‹åºå¼‚å¸¸é€€å‡ºåè‡ªåŠ¨é‡å¯
- **æ—¥å¿—ç®¡ç†**:é›†æˆ journalctl æ—¥å¿—ç³»ç»Ÿ
- **ä¾èµ–ç®¡ç†**:ç¡®ä¿ä¾èµ–æœåŠ¡(MySQLã€RabbitMQ)å…ˆå¯åŠ¨

**æœåŠ¡é…ç½®æ–‡ä»¶è®¾è®¡**:

å‚è€ƒ TODO.md 6.2 èŠ‚,åˆ›å»º `/etc/systemd/system/chatserver.service`:

```ini
[Unit]
Description=AI Chat Server
After=network.target mysql.service rabbitmq-server.service

[Service]
Type=simple
User=www-data
WorkingDirectory=/opt/SiriusX-HttpServer
ExecStart=/opt/SiriusX-HttpServer/build/http_server
Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target
```

**é…ç½®æ–‡ä»¶æ·±åº¦è§£è¯»**:

**[Unit] éƒ¨åˆ† - æœåŠ¡æè¿°ä¸ä¾èµ–**:

1. **`Description`**:æœåŠ¡çš„äººç±»å¯è¯»æè¿°
   - åœ¨ `systemctl status` ä¸­æ˜¾ç¤º
   - å¸®åŠ©è¿ç»´äººå‘˜ç†è§£æœåŠ¡åŠŸèƒ½

2. **`After=network.target mysql.service rabbitmq-server.service`**:
   - **é—®é¢˜**:ä¸ºä»€ä¹ˆéœ€è¦ `After`?
   - **æ€è€ƒ**:å¦‚æœ MySQL è¿˜æ²¡å¯åŠ¨,æˆ‘ä»¬çš„åº”ç”¨è¿æ¥æ•°æ®åº“ä¼šå¤±è´¥
   - **è®¾è®¡**:ç¡®ä¿ä¾èµ–æœåŠ¡å…ˆå¯åŠ¨,å†å¯åŠ¨æˆ‘ä»¬çš„åº”ç”¨
   - **æ‰©å±•æ€è€ƒ**:å¦‚æœ MySQL å¯åŠ¨å¤±è´¥,æˆ‘ä»¬çš„æœåŠ¡ä¼šæ€æ ·?

**[Service] éƒ¨åˆ† - è¿è¡Œé…ç½®**:

1. **`Type=simple`**:
   - è¡¨ç¤ºä¸»è¿›ç¨‹ä¸ä¼š fork(åˆ›å»ºå­è¿›ç¨‹åé€€å‡º)
   - é€‚åˆæˆ‘ä»¬çš„åº”ç”¨(muduo ç½‘ç»œåº“åœ¨ä¸»çº¿ç¨‹è¿è¡Œäº‹ä»¶å¾ªç¯)
   - **å¯¹æ¯”**:`Type=forking` é€‚åˆä¼ ç»Ÿçš„å®ˆæŠ¤è¿›ç¨‹

2. **`User=www-data`**:
   - **å®‰å…¨æ€è€ƒ**:ä¸ºä»€ä¹ˆä¸ç”¨ root è¿è¡Œ?
   - **åŸåˆ™**:æœ€å°æƒé™åŸåˆ™ - å³ä½¿ç¨‹åºè¢«æ”»å‡»,æ”»å‡»è€…ä¹Ÿåªæœ‰ www-data æƒé™
   - **å®è·µ**:ç¡®ä¿ www-data ç”¨æˆ·æœ‰æƒé™è¯»å–é…ç½®æ–‡ä»¶ã€å†™å…¥æ—¥å¿—ç›®å½•

3. **`WorkingDirectory=/opt/SiriusX-HttpServer`**:
   - **ä½œç”¨**:ç¨‹åºçš„å½“å‰å·¥ä½œç›®å½•
   - **é‡è¦æ€§**:å½±å“ç›¸å¯¹è·¯å¾„çš„è§£æ(å¦‚ `config/config.json`)
   - **éªŒè¯**:ç¡®ä¿èµ„æºæ–‡ä»¶(HTMLã€å›¾ç‰‡)çš„ç›¸å¯¹è·¯å¾„æ­£ç¡®

4. **`ExecStart`**:
   - å®é™…æ‰§è¡Œçš„å‘½ä»¤(ç»å¯¹è·¯å¾„)
   - **æ€è€ƒ**:å¦‚æœéœ€è¦å‘½ä»¤è¡Œå‚æ•°æ€ä¹ˆåŠ?
     ```ini
     ExecStart=/opt/SiriusX-HttpServer/build/http_server --config /etc/chatserver/config.json
     ```

5. **`Restart=on-failure`**:
   - **ç­–ç•¥**:éæ­£å¸¸é€€å‡ºæ—¶è‡ªåŠ¨é‡å¯
   - **å¯¹æ¯”**:
     - `no`:ä¸é‡å¯
     - `always`:æ€»æ˜¯é‡å¯(åŒ…æ‹¬æ­£å¸¸é€€å‡º)
     - `on-failure`:ä»…å¼‚å¸¸é€€å‡ºæ—¶é‡å¯ âœ…
   - **åº”ç”¨åœºæ™¯**:ç¨‹åºå´©æºƒã€å†…å­˜æº¢å‡ºã€ä¾èµ–æœåŠ¡çŸ­æš‚ä¸­æ–­

6. **`RestartSec=5`**:
   - **ä½œç”¨**:é‡å¯å‰ç­‰å¾… 5 ç§’
   - **æ€è€ƒ**:ä¸ºä»€ä¹ˆéœ€è¦ç­‰å¾…?
   - **åŸå› **:é¿å…å¿«é€Ÿé‡å¯å¾ªç¯(ä¾‹å¦‚é…ç½®é”™è¯¯å¯¼è‡´ç«‹å³å´©æºƒ)
   - **æ‰©å±•**:å¯ä»¥é…åˆ `StartLimitInterval` å’Œ `StartLimitBurst` é™åˆ¶é‡å¯æ¬¡æ•°

**[Install] éƒ¨åˆ† - å¯ç”¨é…ç½®**:

1. **`WantedBy=multi-user.target`**:
   - **å«ä¹‰**:ç³»ç»Ÿè¿›å…¥å¤šç”¨æˆ·æ¨¡å¼æ—¶å¯åŠ¨
   - **æ•ˆæœ**:ç­‰åŒäº `systemctl enable chatserver` çš„ç›®æ ‡

**Systemd æœåŠ¡æ“ä½œå‘½ä»¤**:

```bash
# 1. é‡æ–°åŠ è½½ systemd é…ç½®(åˆ›å»ºæˆ–ä¿®æ”¹æœåŠ¡æ–‡ä»¶åå¿…é¡»æ‰§è¡Œ)
sudo systemctl daemon-reload

# 2. å¯ç”¨æœåŠ¡(å¼€æœºè‡ªå¯)
sudo systemctl enable chatserver

# 3. å¯åŠ¨æœåŠ¡
sudo systemctl start chatserver

# 4. æŸ¥çœ‹æœåŠ¡çŠ¶æ€
sudo systemctl status chatserver

# 5. æŸ¥çœ‹å®æ—¶æ—¥å¿—
sudo journalctl -u chatserver -f

# 6. æŸ¥çœ‹æœ€è¿‘ 100 è¡Œæ—¥å¿—
sudo journalctl -u chatserver -n 100

# 7. åœæ­¢æœåŠ¡
sudo systemctl stop chatserver

# 8. é‡å¯æœåŠ¡
sudo systemctl restart chatserver
```

**è°ƒè¯•æŠ€å·§**:

**é—®é¢˜åœºæ™¯ 1**:æœåŠ¡å¯åŠ¨å¤±è´¥

```bash
# æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯
sudo journalctl -u chatserver -xe

# å¸¸è§é”™è¯¯:
# - æ‰¾ä¸åˆ°å¯æ‰§è¡Œæ–‡ä»¶:æ£€æŸ¥ ExecStart è·¯å¾„
# - æƒé™ä¸è¶³:æ£€æŸ¥æ–‡ä»¶æ‰€æœ‰è€…å’Œæƒé™
# - ä¾èµ–æœåŠ¡æœªå¯åŠ¨:æ£€æŸ¥ After é…ç½®
```

**é—®é¢˜åœºæ™¯ 2**:æœåŠ¡å¯åŠ¨åç«‹å³é€€å‡º

```bash
# æŸ¥çœ‹é€€å‡ºçŠ¶æ€ç 
sudo systemctl status chatserver

# åˆ†æé€€å‡ºåŸå› :
# - code=exited, status=1:ç¨‹åºå¼‚å¸¸é€€å‡º(æ£€æŸ¥æ—¥å¿—)
# - code=killed, signal=TERM:è¢«æ‰‹åŠ¨ç»ˆæ­¢
# - code=killed, signal=KILL:å†…å­˜æº¢å‡ºè¢« OOM Killer æ€æ­»
```

### æ–¹å¼ä¸‰:Docker å®¹å™¨åŒ–(ç°ä»£åŒ–éƒ¨ç½²)

**ä¸ºä»€ä¹ˆéœ€è¦ Docker?**

**æ ¸å¿ƒä¼˜åŠ¿**:

1. **ç¯å¢ƒä¸€è‡´æ€§**:
   - **é—®é¢˜**:"åœ¨æˆ‘çš„æœºå™¨ä¸Šèƒ½è·‘" vs "åœ¨æœåŠ¡å™¨ä¸Šå´©æºƒ"
   - **è§£å†³**:å¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ä½¿ç”¨å®Œå…¨ç›¸åŒçš„å®¹å™¨é•œåƒ
   - **åŸç†**:Docker é•œåƒåŒ…å«å®Œæ•´çš„è¿è¡Œæ—¶ç¯å¢ƒ(OSã€ä¾èµ–åº“ã€åº”ç”¨)

2. **å¿«é€Ÿéƒ¨ç½²**:
   - **ä¼ ç»Ÿæ–¹å¼**:åœ¨æ–°æœåŠ¡å™¨ä¸Šå®‰è£…æ‰€æœ‰ä¾èµ–(è€—æ—¶æ•°å°æ—¶)
   - **Docker æ–¹å¼**:`docker run` å³å¯å¯åŠ¨(è€—æ—¶æ•°åˆ†é’Ÿ)
   - **æ‰©å±•åœºæ™¯**:å¤šå°æœåŠ¡å™¨éƒ¨ç½²åªéœ€æ‹·è´é•œåƒ

3. **èµ„æºéš”ç¦»**:
   - **é—®é¢˜**:å¤šä¸ªåº”ç”¨å…±ç”¨æœåŠ¡å™¨æ—¶å¯èƒ½äº’ç›¸å½±å“(ç«¯å£å†²çªã€èµ„æºç«äº‰)
   - **è§£å†³**:æ¯ä¸ªå®¹å™¨æœ‰ç‹¬ç«‹çš„æ–‡ä»¶ç³»ç»Ÿã€ç½‘ç»œã€è¿›ç¨‹ç©ºé—´
   - **å®è·µ**:å¯ä»¥åœ¨åŒä¸€å°æœåŠ¡å™¨ä¸Šè¿è¡Œå¤šä¸ªä¸åŒç‰ˆæœ¬çš„åº”ç”¨

**Docker æ¦‚å¿µç†è§£**:

```
é•œåƒ(Image)           â†’     å®¹å™¨(Container)      â†’    æ•°æ®å·(Volume)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ç±»æ¯”:ç¨‹åºæºä»£ç           ç±»æ¯”:è¿è¡Œä¸­çš„è¿›ç¨‹         ç±»æ¯”:æŒ‚è½½çš„ç¡¬ç›˜
ç‰¹ç‚¹:åªè¯»ã€å¯å¤ç”¨        ç‰¹ç‚¹:å¯å†™ã€ä¸´æ—¶           ç‰¹ç‚¹:æŒä¹…åŒ–å­˜å‚¨
æ“ä½œ:build æ„å»º          æ“ä½œ:run å¯åŠ¨             æ“ä½œ:mount æŒ‚è½½
```

**Dockerfile è®¾è®¡æ€è€ƒ**:

```dockerfile
# åŸºç¡€é•œåƒé€‰æ‹©
FROM ubuntu:22.04

# æ€è€ƒ:ä¸ºä»€ä¹ˆé€‰æ‹© Ubuntu 22.04?
# - ä¸ç”Ÿäº§ç¯å¢ƒ OS ç‰ˆæœ¬ä¸€è‡´
# - å®˜æ–¹é•¿æœŸæ”¯æŒ(LTS)ç‰ˆæœ¬
# - å¯ä»¥æ›¿æ¢ä¸º alpine(æ›´å°) æˆ– debian(æ›´é€šç”¨)

# è®¾ç½®æ—¶åŒº(é¿å…äº¤äº’å¼æç¤º)
ENV DEBIAN_FRONTEND=noninteractive
RUN ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime

# å®‰è£…ä¾èµ–
RUN apt-get update && apt-get install -y \
    g++ cmake make \
    libboost-all-dev \
    libmuduo-dev \
    libmysqlcppconn-dev \
    libssl-dev \
    nlohmann-json3-dev \
    libcurl4-openssl-dev \
    libopencv-dev \
    && rm -rf /var/lib/apt/lists/*

# æ€è€ƒ:ä¸ºä»€ä¹ˆæœ€ååˆ é™¤ apt ç¼“å­˜?
# - å‡å°é•œåƒå¤§å°(æ¯ä¸€å±‚éƒ½ä¼šå ç”¨ç©ºé—´)
# - éµå¾ª Docker æœ€ä½³å®è·µ:å•ä¸ª RUN å‘½ä»¤é“¾å¼æ‰§è¡Œ

# åˆ›å»ºå·¥ä½œç›®å½•
WORKDIR /app

# æ‹·è´æºä»£ç 
COPY . /app

# ç¼–è¯‘åº”ç”¨
RUN mkdir build && cd build && cmake .. && make

# æ€è€ƒ:åº”è¯¥åœ¨ Docker å†…ç¼–è¯‘è¿˜æ˜¯å¤–éƒ¨ç¼–è¯‘åæ‹·è´?
# - å†…éƒ¨ç¼–è¯‘:ç¡®ä¿ç¼–è¯‘ç¯å¢ƒä¸€è‡´
# - å¤–éƒ¨ç¼–è¯‘:æ›´å¿«çš„é•œåƒæ„å»º(æ¨èä½¿ç”¨å¤šé˜¶æ®µæ„å»º)

# æš´éœ²ç«¯å£
EXPOSE 80 443

# å¯åŠ¨å‘½ä»¤
CMD ["/app/build/http_server"]

# æ€è€ƒ:CMD vs ENTRYPOINT çš„åŒºåˆ«?
# - CMD:å¯ä»¥è¢« docker run å‘½ä»¤è¦†ç›–
# - ENTRYPOINT:ä½œä¸ºå›ºå®šå…¥å£ç‚¹,CMD ä½œä¸ºå‚æ•°
```

**å¤šé˜¶æ®µæ„å»ºä¼˜åŒ–**:

```dockerfile
# é˜¶æ®µ 1:ç¼–è¯‘ç¯å¢ƒ
FROM ubuntu:22.04 AS builder

RUN apt-get update && apt-get install -y \
    g++ cmake make \
    libboost-all-dev \
    libmuduo-dev \
    libmysqlcppconn-dev \
    libssl-dev \
    nlohmann-json3-dev \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /build
COPY . .
RUN mkdir build && cd build && cmake .. && make

# é˜¶æ®µ 2:è¿è¡Œç¯å¢ƒ(åªåŒ…å«è¿è¡Œæ—¶ä¾èµ–)
FROM ubuntu:22.04

RUN apt-get update && apt-get install -y \
    libmuduo-net \
    libmysqlcppconn8 \
    libssl3 \
    libcurl4 \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# åªæ‹·è´ç¼–è¯‘äº§ç‰©å’Œèµ„æºæ–‡ä»¶
COPY --from=builder /build/build/http_server /app/
COPY --from=builder /build/resource /app/resource

EXPOSE 80 443
CMD ["/app/http_server"]

# ä¼˜åŠ¿:æœ€ç»ˆé•œåƒä¸åŒ…å«ç¼–è¯‘å·¥å…·,å¤§å°å‡å°‘ 50% ä»¥ä¸Š
```

**Docker Compose ç¼–æ’**:

**é—®é¢˜**:æˆ‘ä»¬çš„åº”ç”¨ä¾èµ– MySQL å’Œ RabbitMQ,å¦‚ä½•ä¸€èµ·ç®¡ç†?

**è§£å†³æ–¹æ¡ˆ**:`docker-compose.yml` å®šä¹‰å¤šå®¹å™¨åº”ç”¨

```yaml
version: '3.8'

services:
  # MySQL æ•°æ®åº“
  mysql:
    image: mysql:5.7
    container_name: chatserver_mysql
    environment:
      MYSQL_ROOT_PASSWORD: root_password
      MYSQL_DATABASE: chatserver_db
      MYSQL_USER: chatserver
      MYSQL_PASSWORD: chatserver_password
    volumes:
      - mysql_data:/var/lib/mysql
      - ./sql/init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "3306:3306"
    networks:
      - chatserver_net
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  # RabbitMQ æ¶ˆæ¯é˜Ÿåˆ—
  rabbitmq:
    image: rabbitmq:3-management
    container_name: chatserver_rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
    ports:
      - "5672:5672"
      - "15672:15672"  # ç®¡ç†ç•Œé¢
    networks:
      - chatserver_net
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # èŠå¤©æœåŠ¡å™¨åº”ç”¨
  chatserver:
    build: .
    container_name: chatserver_app
    depends_on:
      mysql:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    environment:
      DB_HOST: mysql
      DB_USER: chatserver
      DB_PASSWORD: chatserver_password
      DB_NAME: chatserver_db
      MQ_HOST: rabbitmq
    volumes:
      - ./config:/app/config
      - ./logs:/app/logs
      - ./resource:/app/resource
    ports:
      - "80:80"
      - "443:443"
    networks:
      - chatserver_net
    restart: unless-stopped

# æ•°æ®å·(æŒä¹…åŒ–å­˜å‚¨)
volumes:
  mysql_data:

# ç½‘ç»œ(å®¹å™¨é—´é€šä¿¡)
networks:
  chatserver_net:
    driver: bridge
```

**é…ç½®æ–‡ä»¶æ·±åº¦è§£è¯»**:

**æœåŠ¡ä¾èµ–ä¸å¯åŠ¨é¡ºåº**:

```yaml
depends_on:
  mysql:
    condition: service_healthy  # ç­‰å¾… MySQL å¥åº·æ£€æŸ¥é€šè¿‡
  rabbitmq:
    condition: service_healthy  # ç­‰å¾… RabbitMQ å¥åº·æ£€æŸ¥é€šè¿‡
```

**æ€è€ƒ**:ä¸ºä»€ä¹ˆéœ€è¦ `healthcheck`?

- **é—®é¢˜**:å®¹å™¨å¯åŠ¨ä¸ä»£è¡¨æœåŠ¡å°±ç»ª(MySQL å¯åŠ¨éœ€è¦åˆå§‹åŒ–æ•°æ®åº“)
- **è§£å†³**:å¥åº·æ£€æŸ¥ç¡®ä¿æœåŠ¡çœŸæ­£å¯ç”¨åå†å¯åŠ¨ä¾èµ–å®ƒçš„æœåŠ¡
- **å®è·µ**:é¿å…åº”ç”¨å¯åŠ¨æ—¶è¿æ¥æ•°æ®åº“å¤±è´¥

**ç¯å¢ƒå˜é‡æ³¨å…¥**:

```yaml
environment:
  DB_HOST: mysql          # Docker ç½‘ç»œå†…çš„ä¸»æœºå
  DB_USER: chatserver
  DB_PASSWORD: chatserver_password
```

**å¯¹åº”çš„åº”ç”¨ä»£ç ä¿®æ”¹**:

```cpp
// ä»ç¯å¢ƒå˜é‡è¯»å–é…ç½®
const char* dbHost = std::getenv("DB_HOST");
const char* dbUser = std::getenv("DB_USER");
const char* dbPassword = std::getenv("DB_PASSWORD");

if (!dbHost || !dbUser || !dbPassword) {
    LOG_FATAL << "ç¼ºå°‘å¿…éœ€çš„ç¯å¢ƒå˜é‡";
    return 1;
}

dbPool.init(dbHost, dbUser, dbPassword, "chatserver_db", 10);
```

**Docker Compose æ“ä½œå‘½ä»¤**:

```bash
# 1. å¯åŠ¨æ‰€æœ‰æœåŠ¡(åå°è¿è¡Œ)
docker-compose up -d

# 2. æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-compose ps

# 3. æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f chatserver

# 4. åœæ­¢æ‰€æœ‰æœåŠ¡
docker-compose down

# 5. åœæ­¢å¹¶åˆ é™¤æ•°æ®å·(å®Œå…¨æ¸…ç†)
docker-compose down -v

# 6. é‡æ–°æ„å»ºé•œåƒ
docker-compose build

# 7. é‡å¯å•ä¸ªæœåŠ¡
docker-compose restart chatserver

# 8. è¿›å…¥å®¹å™¨å†…éƒ¨è°ƒè¯•
docker-compose exec chatserver /bin/bash
```

---

## ğŸ” å®‰å…¨åŠ å›ºç­–ç•¥

### é—®é¢˜4:ç”Ÿäº§ç¯å¢ƒçš„å®‰å…¨å¨èƒæœ‰å“ªäº›?

**å¨èƒæ¨¡å‹åˆ†æ**:

1. **ç½‘ç»œå±‚æ”»å‡»**:
   - DDoS æ”»å‡»:å¤§é‡è¯·æ±‚å¯¼è‡´æœåŠ¡ç˜«ç—ª
   - ç«¯å£æ‰«æ:æ”»å‡»è€…æ¢æµ‹å¼€æ”¾ç«¯å£
   - ä¸­é—´äººæ”»å‡»:æœªåŠ å¯†é€šä¿¡è¢«çªƒå¬

2. **åº”ç”¨å±‚æ”»å‡»**:
   - SQL æ³¨å…¥:æ¶æ„ SQL è¯­å¥æ”»å‡»æ•°æ®åº“
   - XSS æ”»å‡»:æ³¨å…¥æ¶æ„è„šæœ¬æ”»å‡»ç”¨æˆ·
   - CSRF æ”»å‡»:ä¼ªé€ ç”¨æˆ·è¯·æ±‚
   - æš´åŠ›ç ´è§£:å°è¯•å¤§é‡å¯†ç ç»„åˆ

3. **ç³»ç»Ÿå±‚é£é™©**:
   - å¯†ç æ³„éœ²:é…ç½®æ–‡ä»¶ã€æ—¥å¿—ä¸­çš„æ˜æ–‡å¯†ç 
   - æƒé™æ»¥ç”¨:ç¨‹åºä»¥ root æƒé™è¿è¡Œ
   - ä¾èµ–æ¼æ´:ä½¿ç”¨çš„ç¬¬ä¸‰æ–¹åº“å­˜åœ¨å·²çŸ¥æ¼æ´

### å®‰å…¨åŠ å›ºæªæ–½

**1. HTTPS å¼ºåˆ¶å¯ç”¨**:

```cpp
// ç”Ÿäº§ç¯å¢ƒå¼ºåˆ¶å¯ç”¨ SSL
#ifdef PRODUCTION
    if (!config.ssl_enabled) {
        LOG_FATAL << "ç”Ÿäº§ç¯å¢ƒå¿…é¡»å¯ç”¨ HTTPS!";
        return 1;
    }
#endif

// è‡ªåŠ¨å°† HTTP è¯·æ±‚é‡å®šå‘åˆ° HTTPS
server.Get("/*", [](const HttpRequest& req, HttpResponse* resp) {
    if (!req.isSecure()) {
        std::string httpsUrl = "https://" + req.getHeader("Host") + req.path();
        resp->setStatusCode(301);  // Moved Permanently
        resp->addHeader("Location", httpsUrl);
        return;
    }
    // æ­£å¸¸å¤„ç†...
});
```

**æ€è€ƒ**:ä¸ºä»€ä¹ˆä½¿ç”¨ 301 è€Œä¸æ˜¯ 302?
- 301:æ°¸ä¹…é‡å®šå‘,æµè§ˆå™¨ä¼šç¼“å­˜,ä¸‹æ¬¡ç›´æ¥è®¿é—® HTTPS
- 302:ä¸´æ—¶é‡å®šå‘,æ¯æ¬¡éƒ½è¦å…ˆè®¿é—® HTTP

**2. é™æµä¿æŠ¤**:

```cpp
// ä¸­é—´ä»¶:IP è®¿é—®é¢‘ç‡é™åˆ¶
class RateLimitMiddleware : public Middleware {
private:
    struct RateLimitInfo {
        int count;
        std::chrono::steady_clock::time_point resetTime;
    };

    std::unordered_map<std::string, RateLimitInfo> ipRequestCount_;
    std::mutex mutex_;
    const int MAX_REQUESTS_PER_MINUTE = 60;

public:
    void processBefore(HttpRequest& req) override {
        std::string clientIp = req.getClientIp();

        std::lock_guard<std::mutex> lock(mutex_);
        auto now = std::chrono::steady_clock::now();

        auto& info = ipRequestCount_[clientIp];

        // é‡ç½®è®¡æ•°å™¨
        if (now >= info.resetTime) {
            info.count = 0;
            info.resetTime = now + std::chrono::minutes(1);
        }

        info.count++;

        // è¶…è¿‡é™åˆ¶,æ‹’ç»è¯·æ±‚
        if (info.count > MAX_REQUESTS_PER_MINUTE) {
            throw TooManyRequestsException("è¯·æ±‚è¿‡äºé¢‘ç¹,è¯·ç¨åå†è¯•");
        }
    }
};
```

**æ€è€ƒ**:è¿™ä¸ªå®ç°æœ‰ä»€ä¹ˆé—®é¢˜?

- **å†…å­˜æ³„æ¼**:ipRequestCount_ ä¼šæ— é™å¢é•¿
- **æ”¹è¿›**:å®šæœŸæ¸…ç†è¿‡æœŸçš„ IP è®°å½•
- **æ‰©å±•**:ä½¿ç”¨ Redis å®ç°åˆ†å¸ƒå¼é™æµ

**3. å¯†ç å®‰å…¨å­˜å‚¨**:

```cpp
#include <openssl/sha.h>
#include <openssl/rand.h>

class PasswordUtil {
public:
    // ç”Ÿæˆéšæœºç›å€¼
    static std::string generateSalt() {
        unsigned char salt[16];
        RAND_bytes(salt, sizeof(salt));
        return base64Encode(salt, sizeof(salt));
    }

    // ä½¿ç”¨ bcrypt æˆ– scrypt(ç®€åŒ–ç¤ºä¾‹ä½¿ç”¨ SHA256 + salt)
    static std::string hashPassword(const std::string& password,
                                    const std::string& salt) {
        std::string saltedPassword = password + salt;

        unsigned char hash[SHA256_DIGEST_LENGTH];
        SHA256(reinterpret_cast<const unsigned char*>(saltedPassword.c_str()),
               saltedPassword.length(), hash);

        return base64Encode(hash, SHA256_DIGEST_LENGTH);
    }

    // éªŒè¯å¯†ç 
    static bool verifyPassword(const std::string& password,
                              const std::string& salt,
                              const std::string& storedHash) {
        return hashPassword(password, salt) == storedHash;
    }
};
```

**æ•°æ®åº“å­˜å‚¨**:

```sql
CREATE TABLE users (
    user_id INT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,  -- å­˜å‚¨å“ˆå¸Œåçš„å¯†ç 
    password_salt VARCHAR(255) NOT NULL,  -- å­˜å‚¨ç›å€¼
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**ç™»å½•éªŒè¯**:

```cpp
// ChatLoginHandler::handle()
auto stmt = conn->prepareStatement(
    "SELECT password_hash, password_salt FROM users WHERE username = ?");
stmt->setString(1, username);
auto res = stmt->executeQuery();

if (res->next()) {
    std::string storedHash = res->getString("password_hash");
    std::string salt = res->getString("password_salt");

    if (PasswordUtil::verifyPassword(password, salt, storedHash)) {
        // ç™»å½•æˆåŠŸ
    } else {
        // å¯†ç é”™è¯¯
    }
} else {
    // ç”¨æˆ·ä¸å­˜åœ¨
}
```

**4. æ—¥å¿—è„±æ•**:

```cpp
class Logger {
public:
    static std::string sanitize(const std::string& message) {
        std::string result = message;

        // è„±æ•å¯†ç å­—æ®µ
        std::regex passwordPattern(R"("password"\s*:\s*"[^"]+")");
        result = std::regex_replace(result, passwordPattern,
                                   R"("password":"***")");

        // è„±æ• API å¯†é’¥
        std::regex apiKeyPattern(R"("api_key"\s*:\s*"[^"]+")");
        result = std::regex_replace(result, apiKeyPattern,
                                   R"("api_key":"***")");

        return result;
    }

    static void logRequest(const HttpRequest& req) {
        std::string body = sanitize(req.getBody());
        LOG_INFO << "è¯·æ±‚: " << req.method() << " " << req.path()
                 << ", body: " << body;
    }
};
```

---

## ğŸ“Š ç›‘æ§ä¸è¿ç»´

### é—®é¢˜5:å¦‚ä½•çŸ¥é“ç³»ç»Ÿæ˜¯å¦å¥åº·è¿è¡Œ?

**å…³é”®ç›‘æ§æŒ‡æ ‡è®¾è®¡**:

**1. ä¸šåŠ¡æŒ‡æ ‡**:

```cpp
class BusinessMetrics {
private:
    std::atomic<long> totalUsers_{0};
    std::atomic<long> activeUsers_{0};
    std::atomic<long> totalMessages_{0};
    std::atomic<long> aiRequestCount_{0};
    std::atomic<long> aiRequestSuccess_{0};
    std::atomic<long> aiRequestFailed_{0};

public:
    void recordUserLogin() { activeUsers_++; }
    void recordUserLogout() { activeUsers_--; }
    void recordMessage() { totalMessages_++; }
    void recordAIRequest(bool success) {
        aiRequestCount_++;
        if (success) {
            aiRequestSuccess_++;
        } else {
            aiRequestFailed_++;
        }
    }

    // æš´éœ² Prometheus æ ¼å¼æŒ‡æ ‡
    std::string exportMetrics() const {
        std::ostringstream oss;
        oss << "# HELP chatserver_active_users å½“å‰åœ¨çº¿ç”¨æˆ·æ•°\n";
        oss << "chatserver_active_users " << activeUsers_.load() << "\n";
        oss << "# HELP chatserver_total_messages æ€»æ¶ˆæ¯æ•°\n";
        oss << "chatserver_total_messages " << totalMessages_.load() << "\n";
        oss << "# HELP chatserver_ai_success_rate AI è¯·æ±‚æˆåŠŸç‡\n";

        long total = aiRequestCount_.load();
        double successRate = total > 0 ?
            static_cast<double>(aiRequestSuccess_.load()) / total : 0;
        oss << "chatserver_ai_success_rate " << successRate << "\n";

        return oss.str();
    }
};

// æš´éœ²ç›‘æ§ç«¯ç‚¹
server.Get("/metrics", [&metrics](const HttpRequest& req, HttpResponse* resp) {
    resp->setContentType("text/plain");
    resp->setBody(metrics.exportMetrics());
});
```

**2. ç³»ç»Ÿèµ„æºç›‘æ§**:

```cpp
class SystemMonitor {
public:
    struct SystemInfo {
        double cpuUsage;
        double memoryUsage;
        long openFileDescriptors;
        long threadCount;
    };

    static SystemInfo collectSystemInfo() {
        SystemInfo info;

        // è¯»å– /proc/stat è®¡ç®— CPU ä½¿ç”¨ç‡
        // è¯»å– /proc/meminfo è®¡ç®—å†…å­˜ä½¿ç”¨ç‡
        // è¯»å– /proc/self/status è·å–çº¿ç¨‹æ•°

        return info;
    }
};
```

**3. å¥åº·æ£€æŸ¥ç«¯ç‚¹**:

```cpp
server.Get("/health", [&dbPool, &mqManager](const HttpRequest& req,
                                            HttpResponse* resp) {
    nlohmann::json health;

    // æ•°æ®åº“è¿æ¥æ£€æŸ¥
    try {
        auto conn = dbPool.getConnection();
        auto stmt = conn->prepareStatement("SELECT 1");
        stmt->execute();
        health["database"] = "healthy";
    } catch (const std::exception& e) {
        health["database"] = "unhealthy";
        health["database_error"] = e.what();
    }

    // RabbitMQ è¿æ¥æ£€æŸ¥
    try {
        if (mqManager.isConnected()) {
            health["rabbitmq"] = "healthy";
        } else {
            health["rabbitmq"] = "unhealthy";
        }
    } catch (const std::exception& e) {
        health["rabbitmq"] = "unhealthy";
        health["rabbitmq_error"] = e.what();
    }

    // æ•´ä½“çŠ¶æ€
    bool allHealthy = health["database"] == "healthy" &&
                     health["rabbitmq"] == "healthy";

    health["status"] = allHealthy ? "UP" : "DOWN";

    resp->setStatusCode(allHealthy ? 200 : 503);
    resp->setContentType("application/json");
    resp->setBody(health.dump());
});
```

**è´Ÿè½½å‡è¡¡å™¨é›†æˆ**:

```nginx
# Nginx å¥åº·æ£€æŸ¥é…ç½®
upstream chatserver_backend {
    server 10.0.1.1:80 max_fails=3 fail_timeout=30s;
    server 10.0.1.2:80 max_fails=3 fail_timeout=30s;

    # å®šæœŸæ£€æŸ¥å¥åº·çŠ¶æ€
    health_check interval=5s fails=2 passes=3 uri=/health;
}

server {
    listen 80;
    server_name chat.example.com;

    location / {
        proxy_pass http://chatserver_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

---

## ğŸ“ é˜¶æ®µæ€»ç»“:ç”Ÿäº§éƒ¨ç½²çš„å·¥ç¨‹å¸ˆæ€ç»´

### æ ¸å¿ƒèƒ½åŠ›æå‡

å®Œæˆè¿™ä¸ªé˜¶æ®µå,ä½ åº”è¯¥å…·å¤‡:

1. **é…ç½®ç®¡ç†æ„è¯†**:
   - ç†è§£é…ç½®å¤–éƒ¨åŒ–çš„é‡è¦æ€§
   - æŒæ¡æ•æ„Ÿä¿¡æ¯ä¿æŠ¤çš„æœ€ä½³å®è·µ
   - èƒ½å¤Ÿè®¾è®¡å¤šç¯å¢ƒé…ç½®æ–¹æ¡ˆ

2. **éƒ¨ç½²æ¶æ„æ€ç»´**:
   - ç†è§£ä¸åŒéƒ¨ç½²æ–¹å¼çš„ä¼˜ç¼ºç‚¹
   - æŒæ¡ Systemd æœåŠ¡ç®¡ç†
   - å…·å¤‡å®¹å™¨åŒ–éƒ¨ç½²çš„å®è·µèƒ½åŠ›

3. **å®‰å…¨é˜²æŠ¤æ„è¯†**:
   - è¯†åˆ«å¸¸è§å®‰å…¨å¨èƒ
   - å®æ–½å¤šå±‚æ¬¡å®‰å…¨é˜²æŠ¤
   - å»ºç«‹å®‰å…¨å¼€å‘ä¹ æƒ¯

4. **è¿ç»´ç›‘æ§æ€ç»´**:
   - ç†è§£ç›‘æ§çš„é‡è¦æ€§
   - è®¾è®¡åˆç†çš„ç›‘æ§æŒ‡æ ‡
   - å»ºç«‹æ•…éšœè¯Šæ–­æµç¨‹

### å®è·µå»ºè®®

1. **ä»ç®€å•åˆ°å¤æ‚**:
   - å…ˆæŒæ¡ç›´æ¥éƒ¨ç½²,ç†è§£åŸºæœ¬æµç¨‹
   - å†å­¦ä¹  Systemd,æŒæ¡æœåŠ¡ç®¡ç†
   - æœ€åå°è¯• Docker,ç†è§£å®¹å™¨åŒ–æ€æƒ³

2. **å®‰å…¨ä¼˜å…ˆ**:
   - æ¯ä¸ªåŠŸèƒ½éƒ½è¦è€ƒè™‘å®‰å…¨æ€§
   - æ•æ„Ÿä¿¡æ¯ç»ä¸ç¡¬ç¼–ç 
   - å®šæœŸè¿›è¡Œå®‰å…¨å®¡è®¡

3. **æŒç»­ä¼˜åŒ–**:
   - åŸºäºç›‘æ§æ•°æ®ä¼˜åŒ–æ€§èƒ½
   - æ ¹æ®æ•…éšœæ—¥å¿—æ”¹è¿›ç¨³å®šæ€§
   - è·Ÿè¸ªæœ€æ–°çš„å®‰å…¨æ¼æ´å¹¶ä¿®å¤

### å·¥ç¨‹å¸ˆçš„æ€ç»´æ–¹å¼

**ä»"èƒ½è·‘"åˆ°"ç¨³å®šè¿è¡Œ"çš„è½¬å˜**:

- **å¯é æ€§**:æœåŠ¡ 7x24 å°æ—¶ç¨³å®šè¿è¡Œ
- **å®‰å…¨æ€§**:æŠµå¾¡å¸¸è§æ”»å‡»,ä¿æŠ¤ç”¨æˆ·æ•°æ®
- **å¯ç»´æŠ¤æ€§**:æ¸…æ™°çš„æ—¥å¿—,å®Œå–„çš„ç›‘æ§,å¿«é€Ÿæ•…éšœå®šä½
- **å¯æ‰©å±•æ€§**:èƒ½å¤Ÿæ°´å¹³æ‰©å±•åº”å¯¹ç”¨æˆ·å¢é•¿

**ä»"æœ¬åœ°å¼€å‘"åˆ°"ç”Ÿäº§éƒ¨ç½²"çš„è·¨è¶Š**:

- **ç¯å¢ƒç®¡ç†**:å¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ç¯å¢ƒéš”ç¦»
- **é…ç½®ç®¡ç†**:å¤–éƒ¨åŒ–é…ç½®,å¯†é’¥ç®¡ç†
- **è‡ªåŠ¨åŒ–**:CI/CD è‡ªåŠ¨æ„å»ºéƒ¨ç½²
- **ç›‘æ§å‘Šè­¦**:ä¸»åŠ¨å‘ç°é—®é¢˜,å¿«é€Ÿå“åº”

è®°ä½:**ä¼˜ç§€çš„å·¥ç¨‹å¸ˆä¸ä»…è¦å†™å‡ºå¥½ä»£ç ,æ›´è¦ç¡®ä¿ä»£ç åœ¨ç”Ÿäº§ç¯å¢ƒä¸­å®‰å…¨ã€ç¨³å®šã€é«˜æ•ˆåœ°è¿è¡Œ**

---

## ğŸ’¡ è¿›é˜¶æ€è€ƒé¢˜

åœ¨å®ŒæˆåŸºç¡€éƒ¨ç½²å,æ€è€ƒè¿™äº›è¿›é˜¶é—®é¢˜:

1. **é«˜å¯ç”¨æ€§**:
   - å¦‚æœä¸€å°æœåŠ¡å™¨å®•æœº,å¦‚ä½•ç¡®ä¿æœåŠ¡ä¸ä¸­æ–­?
   - å¦‚ä½•å®ç°æ•°æ®åº“çš„ä¸»ä»å¤åˆ¶å’Œæ•…éšœåˆ‡æ¢?
   - å¦‚ä½•è®¾è®¡æ— çŠ¶æ€æœåŠ¡ä»¥æ”¯æŒè´Ÿè½½å‡è¡¡?

2. **ç°åº¦å‘å¸ƒ**:
   - å¦‚ä½•åœ¨ä¸å½±å“æ‰€æœ‰ç”¨æˆ·çš„æƒ…å†µä¸‹æµ‹è¯•æ–°åŠŸèƒ½?
   - å¦‚ä½•è®¾è®¡é‡‘ä¸é›€å‘å¸ƒç­–ç•¥?
   - å¦‚ä½•å¿«é€Ÿå›æ»šæœ‰é—®é¢˜çš„ç‰ˆæœ¬?

3. **æ€§èƒ½ä¼˜åŒ–**:
   - å¦‚ä½•é€šè¿‡ CDN åŠ é€Ÿé™æ€èµ„æº?
   - å¦‚ä½•ä½¿ç”¨ Redis ç¼“å­˜å‡å°‘æ•°æ®åº“å‹åŠ›?
   - å¦‚ä½•è®¾è®¡åˆ†å¸ƒå¼ä¼šè¯å­˜å‚¨?

4. **æˆæœ¬ä¼˜åŒ–**:
   - å¦‚ä½•æ ¹æ®è´Ÿè½½è‡ªåŠ¨æ‰©ç¼©å®¹?
   - å¦‚ä½•ä¼˜åŒ– AI API è°ƒç”¨æ¬¡æ•°é™ä½æˆæœ¬?
   - å¦‚ä½•è®¾è®¡å­˜å‚¨ç­–ç•¥å¹³è¡¡æ€§èƒ½å’Œæˆæœ¬?

---

*ç°åœ¨,å¼€å§‹ä½ çš„ç”Ÿäº§éƒ¨ç½²ä¹‹æ—…å§!è®°ä½,éƒ¨ç½²ä¸æ˜¯ç»ˆç‚¹,è€Œæ˜¯æŒç»­æ”¹è¿›çš„èµ·ç‚¹ã€‚* ğŸš€âœ¨

**æœ€åæ›´æ–°**:2025-10-21
**æ–‡æ¡£ç‰ˆæœ¬**:v1.0.0
**ä½œè€…**:çŒ«å¨˜å·¥ç¨‹å¸ˆ å¹½æµ®å–µ à¸…'Ï‰'à¸…
